suite: test creation of resources for Talos
values:
  - ../values.scaleway.yaml
release:
  name: test-cluster
  namespace: default
set:
  kommodity.global.configPatches: [{ op: add, path: /my-path, value: my-value }]
templates:
  - templates/*
tests:
  # TalosControlPlane tests
  - it: should make sure a TalosControlPlane is created
    template: templates/talos/controlplane.yaml
    asserts:
      - isKind:
          of: TalosControlPlane
      - hasDocuments:
          count: 1
      - equal:
          path: metadata.name
          value: "test-cluster-controlplane"
      - equal:
          path: spec.infrastructureTemplate.kind
          value: ScalewayMachineTemplate

  # TalosConfigTemplate tests
  - it: should make sure a TalosConfigTemplate is created
    template: templates/talos/configtemplate.yaml
    asserts:
      - isKind:
          of: TalosConfigTemplate
      - hasDocuments:
          count: 1
      - matchRegex:
          path: metadata.name
          pattern: ^test-cluster-worker-default-[a-f0-9]{6}$

  # Hash change tests
  - it: should update the TalosConfigTemplate name when kms config is changed
    template: templates/talos/configtemplate.yaml
    set:
      kommodity.kms.enabled: true
    asserts:
      - isKind:
          of: TalosConfigTemplate
      - hasDocuments:
          count: 1
      - matchRegex:
          path: metadata.name
          pattern: ^test-cluster-worker-default-[a-f0-9]{6}$

  - it: should update the TalosConfigTemplate name when global config patches are changed
    template: templates/talos/configtemplate.yaml
    set:
      kommodity.global.configPatches:
        [{ op: add, path: /new-path, value: new-value }]
    asserts:
      - isKind:
          of: TalosConfigTemplate
      - hasDocuments:
          count: 1
      - matchRegex:
          path: metadata.name
          pattern: ^test-cluster-worker-default-[a-f0-9]{6}$

  - it: should update the TalosConfigTemplate name when nodepool config patches are changed
    template: templates/talos/configtemplate.yaml
    set:
      kommodity.nodepools.default.configPatches:
        [{ op: add, path: /new-path, value: new-value }]
    asserts:
      - isKind:
          of: TalosConfigTemplate
      - hasDocuments:
          count: 1
      - matchRegex:
          path: metadata.name
          pattern: ^test-cluster-worker-default-[a-f0-9]{6}$

  - it: should update the TalosConfigTemplate name when Talos version is changed
    template: templates/talos/configtemplate.yaml
    set:
      talos.version: "new-version"
    asserts:
      - isKind:
          of: TalosConfigTemplate
      - hasDocuments:
          count: 1
      - matchRegex:
          path: metadata.name
          pattern: ^test-cluster-worker-default-[a-f0-9]{6}$

  # Config patch merging tests
  - it: should merge patches with same op and path
    template: templates/talos/configtemplate.yaml
    set:
      kommodity.global.configPatches:
        - op: add
          path: /machine/env
          value:
            GLOBAL_VAR: global-value
      kommodity.nodepools.default.configPatches:
        - op: add
          path: /machine/env
          value:
            NODEPOOL_VAR: nodepool-value
    asserts:
      - isKind:
          of: TalosConfigTemplate
      - hasDocuments:
          count: 1
      - matchRegex:
          path: metadata.name
          pattern: ^test-cluster-worker-default-[a-f0-9]{6}$
      - contains:
          path: spec.template.spec.configPatches
          content:
            op: add
            path: /machine/env
            value:
              GLOBAL_VAR: global-value
              LOG_LEVEL: warn
              NODEPOOL_VAR: nodepool-value

  - it: should not merge patches with different ops on same path
    template: templates/talos/configtemplate.yaml
    set:
      kommodity.global.configPatches:
        - op: add
          path: /machine/env
          value:
            ADD_VAR: add-value
        - op: replace
          path: /machine/env
          value:
            REPLACE_VAR: replace-value
    asserts:
      - isKind:
          of: TalosConfigTemplate
      - hasDocuments:
          count: 1
      - matchRegex:
          path: metadata.name
          pattern: ^test-cluster-worker-default-[a-f0-9]{6}$
      - contains:
          path: spec.template.spec.configPatches
          content:
            op: add
            path: /machine/env
            value:
              ADD_VAR: add-value
              LOG_LEVEL: warn
      - contains:
          path: spec.template.spec.configPatches
          content:
            op: replace
            path: /machine/env
            value:
              REPLACE_VAR: replace-value

  # Taints tests
  - it: should generate kubelet extraArgs and nodeTaints patches for taints
    template: templates/talos/configtemplate.yaml
    set:
      kommodity.global.configPatches: []
      kommodity.nodepools.default.taints:
        workload: "gpu:NoSchedule"
    asserts:
      - isKind:
          of: TalosConfigTemplate
      - hasDocuments:
          count: 1
      - matchRegex:
          path: metadata.name
          pattern: ^test-cluster-worker-default-[a-f0-9]{6}$
      - contains:
          path: spec.template.spec.configPatches
          content:
            op: add
            path: /machine/kubelet/extraArgs
            value:
              register-with-taints: "workload=gpu:NoSchedule"
      - contains:
          path: spec.template.spec.configPatches
          content:
            op: add
            path: /machine/nodeTaints
            value:
              workload: "gpu:NoSchedule"

  # Labels and annotations tests
  - it: should generate nodeLabels and nodeAnnotations patches
    template: templates/talos/configtemplate.yaml
    set:
      kommodity.global.configPatches: []
    asserts:
      - isKind:
          of: TalosConfigTemplate
      - hasDocuments:
          count: 1
      - contains:
          path: spec.template.spec.configPatches
          content:
            op: add
            path: /machine/nodeLabels
            value:
              my-label: my-value
      - contains:
          path: spec.template.spec.configPatches
          content:
            op: add
            path: /machine/nodeAnnotations
            value:
              my-annotation: my-annotation-value

  # Test Talos version and image precedence
  - it: should make sure Talos version defined in nodepool's config take precedence
    template: templates/talos/configtemplate.yaml
    set:
      talos.version: "global-talos-version"
      kommodity.nodepools.default.talos.version: "nodepool-talos-version"
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: spec.template.spec.talosVersion
          value: "nodepool-talos-version"

  - it: should make sure Talos version defined in controlplane's config take precedence
    template: templates/talos/controlplane.yaml
    set:
      talos.version: "global-talos-version"
      kommodity.controlplane.talos.version: "controlplane-talos-version"
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: spec.controlPlaneConfig.controlplane.talosVersion
          value: "controlplane-talos-version"

  - it: should make sure Talos image defined in nodepool's and controlplane's config take precedence
    template: templates/provider/scaleway/machinetemplate.yaml
    set:
      talos.image: "global-talos-image"
      kommodity.controlplane.talos.imageName: "controlplane-talos-image"
      kommodity.nodepools.default.talos.imageName: "nodepool-talos-image"
    asserts:
      - hasDocuments:
          count: 2
      - equal:
          path: spec.template.spec.image.name
          value: "controlplane-talos-image"
        documentIndex: 0
      - equal:
          path: spec.template.spec.image.name
          value: "nodepool-talos-image"
        documentIndex: 1

  # Test Kubernetes version precedence
  - it: should make sure Kubernetes version defined in controlplane's config take precedence
    template: templates/talos/controlplane.yaml
    set:
      kubernetes.version: "global-kubernetes-version"
      kommodity.controlplane.kubernetes.version: "controlplane-kubernetes-version"
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: spec.version
          value: "controlplane-kubernetes-version"

  # GPU config tests
  - it: should add GPU config patches when gpus.enabled is true
    template: templates/talos/configtemplate.yaml
    set:
      kommodity.global.configPatches: []
      kommodity.nodepools.default.gpus.enabled: true
    asserts:
      - isKind:
          of: TalosConfigTemplate
      - hasDocuments:
          count: 1
      - contains:
          path: spec.template.spec.configPatches
          content:
            op: add
            path: /machine/kernel
            value:
              modules:
                - name: nvidia
                - name: nvidia_uvm
                - name: nvidia_drm
                - name: nvidia_modeset
      - contains:
          path: spec.template.spec.configPatches
          content:
            op: add
            path: /machine/sysctls
            value:
              net.core.bpf_jit_harden: 1
      - contains:
          path: spec.template.spec.configPatches
          content:
            op: add
            path: /machine/files
            value:
              - content: |
                  [plugins]
                    [plugins."io.containerd.cri.v1.runtime"]
                      [plugins."io.containerd.cri.v1.runtime".containerd]
                        default_runtime_name = "nvidia"
                op: create
                path: /etc/cri/conf.d/20-customization.part

  - it: should not add GPU config patches when gpus is not set
    template: templates/talos/configtemplate.yaml
    set:
      kommodity.global.configPatches: []
      kommodity.nodepools.default.gpus: null
    asserts:
      - isKind:
          of: TalosConfigTemplate
      - hasDocuments:
          count: 1
      - notContains:
          path: spec.template.spec.configPatches
          content:
            op: add
            path: /machine/kernel
          any: true
      - notContains:
          path: spec.template.spec.configPatches
          content:
            op: add
            path: /machine/files
          any: true

  - it: should not add GPU config patches when gpus.enabled is false
    template: templates/talos/configtemplate.yaml
    set:
      kommodity.global.configPatches: []
      kommodity.nodepools.default.gpus.enabled: false
    asserts:
      - isKind:
          of: TalosConfigTemplate
      - hasDocuments:
          count: 1
      - notContains:
          path: spec.template.spec.configPatches
          content:
            op: add
            path: /machine/kernel
          any: true
      - notContains:
          path: spec.template.spec.configPatches
          content:
            op: add
            path: /machine/files
          any: true
