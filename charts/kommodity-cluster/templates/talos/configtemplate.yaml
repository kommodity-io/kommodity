{{- range $name, $np := .Values.kommodity.nodepools }}
---
apiVersion: bootstrap.cluster.x-k8s.io/v1alpha3
kind: TalosConfigTemplate
metadata:
  name: {{ $.Release.Name }}-worker-{{ $name }}
  namespace: {{ $.Release.Namespace }}
  labels:
    app.kubernetes.io/managed-by: kommodity
spec:
  template:
    spec:
      generateType: worker
      talosVersion: {{ include "kommodity.talosVersion" $ }}
      {{- if $.Values.kommodity.kms.enabled }}
      strategicPatches:
        - |
          machine:
            systemDiskEncryption:
              state:
                  provider: luks2
                  keys:
                    - kms:
                        endpoint: {{ $.Values.kommodity.kms.endpoint | quote }}
                      slot: 0
              ephemeral:
                  provider: luks2
                  keys:
                    - kms:
                        endpoint: {{ $.Values.kommodity.kms.endpoint | quote }}
                      slot: 0
      {{- end }}
{{- end }}
