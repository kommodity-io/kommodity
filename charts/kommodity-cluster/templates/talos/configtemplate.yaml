{{- range $name, $np := .Values.kommodity.nodepools }}
---
apiVersion: bootstrap.cluster.x-k8s.io/v1alpha3
kind: TalosConfigTemplate
metadata:
  name: {{ $.Release.Name }}-worker-{{ $name }}-{{ include "kommodity-cluster.talosConfigHash" (dict "poolValues" $np "allValues" $.Values) }}
  namespace: {{ $.Release.Namespace }}
  labels:
    app.kubernetes.io/managed-by: kommodity
spec:
  template:
    spec:
      generateType: worker
      talosVersion: {{ default (include "kommodity.talosVersion" $) (dig "talos" "version" "" $np) }}
      {{- $hasNpConfigPatches := and $np.configPatches (gt (len $np.configPatches) 0) }}
      {{- $hasGlobalConfigPatches := and $.Values.kommodity.global.configPatches (gt (len $.Values.kommodity.global.configPatches) 0) }}
      {{- $hasTaints := and $np.taints (gt (len $np.taints) 0) }}
      {{- $hasLabels := and $np.labels (gt (len $np.labels) 0) }}
      {{- $hasAnnotations := and $np.annotations (gt (len $np.annotations) 0) }}
      {{- $hasInstaller := $.Values.talos.installer }}
      {{- $hasLogLevel := $.Values.kommodity.logLevel }}
      {{- /* Check if user has /cluster/inlineManifests in global.configPatches */ -}}
      {{- $userInlineManifests := list }}
      {{- range $.Values.kommodity.global.configPatches }}
        {{- if and (eq .op "add") (eq .path "/cluster/inlineManifests") }}
          {{- $userInlineManifests = .value }}
        {{- end }}
      {{- end }}
      {{- $hasInlineManifests := gt (len $userInlineManifests) 0 }}
      {{- if or $hasNpConfigPatches $hasGlobalConfigPatches $hasTaints $hasLabels $hasAnnotations $hasInstaller $hasLogLevel }}
      configPatches:
      {{- end }}
      {{- /* Output /cluster/inlineManifests patch for user-provided manifests */ -}}
      {{- if $hasInlineManifests }}
        - op: add
          path: /cluster/inlineManifests
          value:
      {{- range $userInlineManifests }}
            - name: {{ .name }}
              contents: |
{{ .contents | indent 16 }}
      {{- end }}
      {{- end }}
      {{- /* Output other patches (excluding /cluster/inlineManifests which is handled above) */ -}}
      {{- if or $hasNpConfigPatches $hasGlobalConfigPatches $hasTaints $hasLabels $hasAnnotations $hasInstaller $hasLogLevel }}
{{- include "kommodity-cluster.combinedConfigPatches" (dict "globalConfigPatches" $.Values.kommodity.global.configPatches "nodepoolConfigPatches" $np.configPatches "taints" $np.taints "labels" $np.labels "annotations" $np.annotations "installer" $.Values.talos.installer "logLevel" $.Values.kommodity.logLevel) | trim | nindent 8 }}
      {{- end }}
      {{- if or $.Values.kommodity.kms.enabled $.Values.kommodity.security.enabled }}
      strategicPatches:
      {{- if $.Values.kommodity.kms.enabled }}
      {{- /* Use VolumeConfig for disk encryption (Talos v1.12+) instead of deprecated machine.systemDiskEncryption */}}
{{- include "kommodity.talos.volumeEncryption" (dict "endpoint" $.Values.kommodity.kms.endpoint) | nindent 8 }}
      {{- end }}
      {{- if $.Values.kommodity.security.enabled }}
      {{- /* ExtensionServiceConfig for kommodity-attestation extension */}}
{{- include "kommodity.talos.attestationExtensionServiceConfig" (dict "logLevel" $.Values.kommodity.logLevel) | nindent 8 }}
      {{- end }}
      {{- end }}
{{- end }}
