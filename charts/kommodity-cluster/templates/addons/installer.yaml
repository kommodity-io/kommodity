{{- define "kommodity.addon.installer" -}}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ .name }}-install
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: {{ .name }}-install
  namespace: kommodity-system
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ .name }}-install
  namespace: kommodity-system
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .name }}-install
  namespace: kommodity-system
spec:
  backoffLimit: 10
  ttlSecondsAfterFinished: 3600
  template:
    metadata:
      labels:
        kommodity.io/addon: {{ .name }}
        app: {{ .name }}-install
    spec:
      restartPolicy: OnFailure
      tolerations:
        - operator: Exists
        - effect: NoSchedule
          operator: Exists
        - effect: NoExecute
          operator: Exists
        - effect: PreferNoSchedule
          operator: Exists
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoExecute
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: PreferNoSchedule
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: node-role.kubernetes.io/control-plane
                    operator: Exists
      serviceAccount: {{ .name }}-install
      serviceAccountName: {{ .name }}-install
      hostNetwork: true
      containers:
        - name: {{ .name }}-install
          image: alpine/k8s:1.34.1
          env:
            - name: KUBERNETES_SERVICE_HOST
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: status.podIP
            - name: KUBERNETES_SERVICE_PORT
              value: "6443"
          command:
            - /bin/sh
            - -c
            - |
              set -eu

              REPOSITORY="{{ .addon.chart.repository }}"
              CHART="{{ .addon.chart.name }}"
              VERSION="{{ .addon.chart.version }}"
              RELEASE="{{ .name }}"
              INSTALL_MODE="{{ default "HelmInstall" .addon.lifecycle.install.mode }}"
              UPGRADE_DISABLE="{{ default true .addon.lifecycle.upgrade.disable }}"
              NAMESPACE="{{ default .name .addon.namespace }}"

              echo "Addon: ${RELEASE}"
              echo "Install Mode: ${INSTALL_MODE}"
              echo "Repository: ${REPOSITORY}"
              echo "Chart: ${CHART}"
              echo "Version: ${VERSION}"
              echo "Upgrade Disable: ${UPGRADE_DISABLE}"

              if [ "${UPGRADE_DISABLE}" = "true" ] || [ "${UPGRADE_DISABLE}" = "True" ] || [ "${UPGRADE_DISABLE}" = "TRUE" ]; then
                # Check if the addon is already installed
                if helm ls -n "${NAMESPACE}" | grep -q "^${RELEASE} "; then
                  echo "Addon ${RELEASE} is already installed, skipping installation due to upgrade.disable=true"
                  exit 0
                fi
              fi

              if [ "${INSTALL_MODE}" = "KubectlApply" ]; then
                # Render manifests with Helm, apply with kubectl
                if echo "${REPOSITORY}" | grep -q '^oci://'; then
                  # OCI: full ref is repo + chart name
                  CHART_REF="${REPOSITORY}/${CHART}"
                  echo "Rendering OCI chart ${CHART_REF} and applying with kubectl"
                  helm template "${RELEASE}" "${CHART_REF}" \
                    --namespace "${NAMESPACE}" \
                    --version "${VERSION}" \
                  | kubectl apply -f -
                else
                  # Non-OCI: use --repo
                  echo "Rendering chart ${CHART} from repo ${REPOSITORY} and applying with kubectl"
                  helm template "${RELEASE}" "${CHART}" \
                    --namespace "${NAMESPACE}" \
                    --repo "${REPOSITORY}" \
                    --version "${VERSION}" \
                  | kubectl apply -f -
                fi
              else
                # Default: HelmInstall (helm upgrade --install)
                if echo "${REPOSITORY}" | grep -q '^oci://'; then
                  # OCI: full ref is repo + chart name
                  CHART_REF="${REPOSITORY}/${CHART}"
                  echo "Installing OCI chart ${CHART_REF}"
                  helm upgrade --install "${RELEASE}" "${CHART_REF}" \
                    --namespace "${NAMESPACE}" \
                    --version "${VERSION}"
                else
                  # Non-OCI: use --repo
                  echo "Installing chart ${CHART} from repo ${REPOSITORY}"
                  helm upgrade --install "${RELEASE}" "${CHART}" \
                    --namespace "${NAMESPACE}" \
                    --repo "${REPOSITORY}" \
                    --version "${VERSION}"
                fi
              fi
{{- end }}
