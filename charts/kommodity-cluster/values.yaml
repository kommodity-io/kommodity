# Default values for kommodity-cluster.
kommodity:
  provider:
    name: Docker

    cloudControllerManager:
      enabled: false

  oidc:
    enabled: false

  kms:
    enabled: false

  clusterAutoscaler:
    # If enabled, each nodepool must have autoscaling.minReplicas and autoscaling.maxReplicas set
    enabled: false
    namespace: kube-system
    chart:
      repository: https://kubernetes.github.io/autoscaler
      name: cluster-autoscaler
      version: 9.52.1
    initialExtraValues:
      fullnameOverride: "cluster-autoscaler"
      clusterScoped: true

  # Cluster networking configuration using CG-NAT ranges: pods 10.64.0.0/11 (~2M IPs), nodes 10.200.0.0/20 (~4K IPs), services 100.96.0.0/12 (~1M IPs)
  network:
    ipv4:
      enabled: true
      # Setting public to false will :
      # - prevent the creation of a public network interface
      # - enable the Talos autoBootstrap extension (nodes are not reachable by Kommodity so they need to bootstrap themselves)
      # - create a private network and attach the nodes to it (Scaleway only)
      # - create a public gateway and attach it to the private network (Scaleway only)
      public: false
    cluster:
      podCIDR:
        - 100.64.0.0/11
      serviceCIDR:
        - 100.96.0.0/12

  extraSecrets: {}
    # Examples of extra secrets to be created in the downstream cluster, type default to Opaque
    # my-namespace:
    #   my-string-data-secret:
    #     type: Opaque
    #     stringData:
    #       my-other-key: my-other-value
    #     labels:
    #       my-label: my-label-value
    # my-other-namespace:
    #   my-data-secret:
    #     data:
    #       username: admin
    #       password: secret

  addons:
    cilium:
      enabled: true
      # Namespace for where the addon will be installed, default is the name of the addon
      namespace: kube-system
      lifecycle:
        install:
          # Install mode can be either: HelmInstall or KubectlApply, default is HelmInstall
          mode: HelmInstall
          # Optional condition to check if the addon is already installed
          # Required for KubectlApply mode to avoid re-applying manifests
          # Optional for HelmInstall mode, default to use `helm ls` to check if the release is installed
          condition: {}
        # Avoid overriding the addon after the initial install, default is true.
        # This is often useful when "adopting" addons with a GitOps tools, such as ArgoCD or Flux.
        upgrade:
          disable: true
      chart:
        repository: https://helm.cilium.io/
        name: cilium
        version: 1.18.4
      # Defines the values to be passed to the downstream Helm chart at first install only, immutable after that
      initialExtraValues:
        enabled: true
        k8sServiceHost: localhost
        k8sServicePort: 7445
        ipam:
          mode: kubernetes
        kubeProxyReplacement: true
        bpf:
          hostLegacyRouting: true
        cgroup:
          autoMount:
            enabled: false
          hostRoot: /sys/fs/cgroup
        securityContext:
          privileged: true
          capabilities:
            ciliumAgent:
              # Use to set socket permission
              - CHOWN
              # Used to terminate envoy child process
              - KILL
              # Used since cilium creates raw sockets, etc...
              - NET_RAW
              # Used since cilium monitor uses mmap
              - IPC_LOCK
              # Used in iptables. Consider removing once we are iptables-free
              - SYS_MODULE
              # Could be an alternative for the SYS_ADMIN for the RLIMIT_NPROC
              - SYS_RESOURCE
              # Both PERFMON and BPF requires kernel 5.8, container runtime
              # cri-o >= v1.22.0 or containerd >= v1.5.0.
              # If available, SYS_ADMIN can be removed.
              - PERFMON
              - BPF
              # Allow discretionary access control (e.g. required for package installation)
              - DAC_OVERRIDE
              # Allow to set Access Control Lists (ACLs) on arbitrary files (e.g. required for package installation)
              - FOWNER
              # Allow to execute program that changes GID (e.g. required for package installation)
              - SETGID
              # Allow to execute program that changes UID (e.g. required for package installation)
              - SETUID
            cleanCiliumState:
              # Most of the capabilities here are the same ones used in the
              # cilium-agent's container because this container can be used to
              # uninstall all Cilium resources, and therefore it is likely that
              # will need the same capabilities.
              # Used since cilium modifies routing tables, etc...
              - NET_ADMIN
              # Could be an alternative for the SYS_ADMIN for the RLIMIT_NPROC
              - SYS_RESOURCE
              # Both PERFMON and BPF requires kernel 5.8, container runtime
              # cri-o >= v1.22.0 or containerd >= v1.5.0.
              # If available, SYS_ADMIN can be removed.
              - PERFMON
              - BPF
        bgpControlPlane:
          enabled: true
        hubble:
          enabled: true
          relay:
            enabled: true
          ui:
            enabled: true
    argocd:
      enabled: false
      # Namespace for where the addon will be installed, default is the name of the addon
      namespace: argocd
      lifecycle:
        install:
          # Install mode can be either: HelmInstall or KubectlApply, default is HelmInstall
          mode: KubectlApply
          # Optional condition to check if the addon is already installed
          # Required for KubectlApply mode to avoid re-applying manifests
          # Optional for HelmInstall mode, default to use `helm ls` to check if the release is installed
          condition:
            # Default kind is Deployment
            kind: Deployment
            matchLabels:
              app.kubernetes.io/name: argocd-server
        # Avoid overriding the addon after the initial install, default is true.
        # This is often useful when "adopting" addons with a GitOps tools, such as ArgoCD or Flux.
        upgrade:
          disable: true
      chart:
        repository: oci://ghcr.io/argoproj/argo-helm
        name: argo-cd
        version: 9.1.2
      # Defines the values to be passed to the downstream Helm chart at first install only, immutable after that
      initialExtraValues:
        enabled: true
        configs:
          cm:
            admin.enabled: false

      # Defines extra environment variables to be added to the installer job
      # extraEnvs:
      #   MY_FIRST_EXTRA_ENV:
      #     valueFrom:
      #       secretKeyRef:
      #         name: my-secret
      #         key: my-key
      #   MY_OTHER_EXTRA_ENV:
      #     value: my-value

      # Defines a script to run before installing the addon
      # preInstallationScript: |
      #   echo "preInstallationScript running"

      # Defines a script to run after installing the addon
      # postInstallationScript: |
      #   echo "postInstallationScript running"

  security:
    enabled: false
    attestationPolicy:
      apparmor:
        enabled: false
      selinux:
        enabled: false
      talosExtensions:
        enabled: false
      talosVersion:
        enabled: false
      talosImage:
        enabled: false
      pcrs:
        enabled: false
      kernelLockdown:
        enabled: false
      secureboot:
        enabled: false
      squashfs:
        enabled: false

  global:
    # Configurations applied to all nodepools and controlplanes in the cluster
    # Using RFC6902 JSON Patch format: https://docs.siderolabs.com/talos/v1.11/configure-your-talos-cluster/system-configuration/patching#rfc6902-json-patches
    configPatches: []

  controlplane:
    # Configurations related to the control plane nodes
    # Using RFC6902 JSON Patch format: https://docs.siderolabs.com/talos/v1.11/configure-your-talos-cluster/system-configuration/patching#rfc6902-json-patches
    configPatches: []

    # Kubernetes version can be overridden here, otherwise the top-level kubernetes.version is used
    # This is especially useful for K8s upgrades, where it is recommended to upgrade the control plane first (https://cluster-api.sigs.k8s.io/tasks/upgrading-clusters#upgrading-using-cluster-api)
    # kubernetes:
    #   version: v1.33.4

    # Talos version and imageName can be overridden here, otherwise the top-level talos.version and talos.imageName are used
    # This is especially useful for Talos upgrades, where it is recommended to not upgrade all nodes at once (https://docs.siderolabs.com/talos/v1.11/configure-your-talos-cluster/lifecycle-management/upgrading-talos)
    # talos:
    #   version: v1.11.3
    #   imageName: talos-base-v1.11.3

    # labels:
    #   my-label: my-value
    # annotations:
    #   my-annotation: my-annotation-value
    # taints:
    #   my-taint: my-taint-value:NoSchedule

    # healthCheck:
    #   enabled: false
    #   maxUnhealthy: 40%
    #   nodeStartupTimeout: 10m0s
    #   unhealthyConditions:
    #   - type: Ready
    #     status: Unknown
    #     timeout: 300s
    #   - type: Ready
    #     status: "False"
    #     timeout: 300s

  nodepools: {}
    ## Example of nodepool configuration
    # default:
    #   # Replicas for this nodepool, default is 1, not used if clusterAutoscaler is enabled
    #   replicas: 1
    #   # Required if clusterAutoscaler is enabled
    #   autoscaling:
    #     minReplicas: 1
    #     maxReplicas: 3

    #   # Configurations related the specific nodepool
    #   # Using RFC6902 JSON Patch format: https://docs.siderolabs.com/talos/v1.11/configure-your-talos-cluster/system-configuration/patching#rfc6902-json-patches
    #   configPatches: []
    #   # Kubernetes version can be overridden here, otherwise the top-level kubernetes.version is used

    #   kubernetes:
    #     version: v1.33.4
    #   # Talos version and imageName can be overridden here, otherwise the top-level talos.version and talos.imageName are used
    #   talos:
    #     version: v1.11.3
    #     imageName: talos-base-v1.11.3

    #   labels:
    #     my-label: my-value
    #   annotations:
    #     my-annotation: my-annotation-value
    #   taints:
    #     my-taint: my-taint-value:NoSchedule

    #   healthCheck:
    #     enabled: false
    #     maxUnhealthy: 40%
    #     nodeStartupTimeout: 10m0s
    #     unhealthyConditions:
    #     - type: Ready
    #       status: Unknown
    #       timeout: 300s
    #     - type: Ready
    #       status: "False"
    #       timeout: 300s

  # Logging verbosity: debug, info, warn, error (set as LOG_LEVEL env var)
  logLevel: warn

# Configurations related to Talos
talos:
  version: v1.11.3
  imageName: my-talos-image
  # installer:
  #   imageName: kommodity-talos-installer:v1.11.3
  #   repository: ghcr.io/kommodity-io
  autoBootstrap:
    # autoBootstrap will be enabled regardless of the enabled value if kommodity.network.ipv4.public is set to false
    enabled: false
    # Network discovery frequency
    scanInterval: 30s
    # Expected number of control plane nodes required for quorum before bootstrapping
    quorumNodes: 1
    # Leader wait time before executing bootstrap
    preBootstrapDelay: 10s
    # Maximum retry backoff period
    maxBackoff: 2m
    # Node probe timeout
    scanTimeout: 2s

  # If true, the Talos CNI will be disabled. Useful when using a different CNI such as Cilium.
  disableCNI: true
  # If true, the Talos built-in kube-proxy will be disabled. Useful when using a different CNI such as Cilium.
  disableKubeProxy: true

# Configurations related to Kubernetes
kubernetes:
  version: v1.33.4
